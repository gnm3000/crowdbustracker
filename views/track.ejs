
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Tracking tu colectivo</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript">
var watchID=0;

function startLocationTracking(){
	if (navigator.geolocation) {
		$("#mylocation").data("status","activo");
		contador();
		alert("Your Browser supports GeoLocation");
		watchID = navigator.geolocation.watchPosition(showCurrentLocation,errorHandler,{enableHighAccuracy: true});
	} else {
		alert("Your Browser does not support GeoLocation.");
	}
}

function showCurrentLocation(position){
	document.getElementById("mylocation").innerHTML = "Tracking your position --> Current Latitude : <span id='latitude'>" + position.coords.latitude + "</span> , Longitude : <span id='longitude'>" + position.coords.longitude+"</span>";
}

function errorHandler(error){
	  alert("Error while retrieving current position. Error code: " + error.code + ",Message: " + error.message);
}

function stopLocationTracking(){
	if (watchID > 0) {
		navigator.geolocation.clearWatch(watchID);
		$("#mylocation").data("status","desactivo");
		alert("Stopped Tracking Location");
	}
}
function finishLocationTracking(){
	if (watchID > 0) {
		navigator.geolocation.clearWatch(watchID);
		alert("Stopped Tracking Location");
		$("#mylocation").data("status","desactivo");
		document.getElementById("mylocation").innerHTML ="Muchas gracias por informar el viaje de tu colectivo.";
	}
}
</script>
</head>
<body>
<h1>Tracking de la ubicacion de tu colectivo</h1>
<h3>Seleccionado: <%=bus%></h3>
<div id="main">
	<div id="mylocation" data-status="desactivo"></div>
	<p>Hacemos tracking de la ubicacion del colectivo cada 30 segundos:</p>
	<p>Ultimo update:<span id="lastUpadate"></span><br/>Hora actual: <span id="time"></span></p>
	<p>Cantidad de updates:<span id="cantUpdate"></span></p>
	<input type="button" value="Comenzar a trackear" onclick="startLocationTracking()"/>
	<input type="button" value="Parar de trackear" onclick="stopLocationTracking()"/>
	<input type="button" value="Finalizar viaje" onclick="finishLocationTracking()"/>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript">
	
var cantUpdate = 0;
function contador(){
console.log("arranca contador");
if($("#mylocation").data("status")=="activo"){
	var latitude = $("#latitude").html();
	var longitude = $("#longitude").html();


	//aca va el jquery a mongodb
	$.ajax( { url: "https://api.mongolab.com/api/1/databases/heroku_app17058222/collections/positions?apiKey=yLBCBklrMclT4A2VNuiWCPrHJmdQ3zjY",
          data: JSON.stringify( { "latitude" : latitude, "longitude":longitude,"datetime":new Date(),bus:"<%=bus%>" } ),
          type: "POST",
          contentType: "application/json" } ).done(function(data){
		          	var fecha = new Date()
					var hora = fecha.getHours()
					var minuto = fecha.getMinutes()
					var segundo = fecha.getSeconds()
					if (hora < 10) {hora = "0" + hora}
					if (minuto < 10) {minuto = "0" + minuto}
					if (segundo < 10) {segundo = "0" + segundo}
					var horita = hora + ":" + minuto + ":" + segundo;
					var fecha_total = horita + ' - ' + fecha.getDate() + "/" + (fecha.getMonth() + 1) +'/'+ fecha.getFullYear();
					  $("#lastUpadate").html(horita);
					  cantUpdate = cantUpdate +1;
					  $("#cantUpdate").html(cantUpdate);
					  console.log("termina contador"+fecha_total);
          });




}
}



	setInterval('contador()',1*30*1000);

	

</script>
<script language="JavaScript">
(function($){
  $.fn.jTime = function(o) {
    var d = {x:'time-capa',ma:new Date(),i:0};
    var o = $.extend(d, o);
    o.ma = new Date(o.ma);
    
    var mHF = function (){
      var ma = new Date(o.ma.getTime() + o.i * 1000);
      h = ma.getHours();
      m = ma.getMinutes();
      s = ma.getSeconds(); 
      if (h<=9) h = '0'+h;
      if (m<=9) m = '0'+m;
      if (s<=9) s = '0'+s;
      hi = h + ":" + m + ":" + s;
      $('#'+o.x).html(hi); 
      o.i += 1;   
    }
    return this.each(function(){
      o.x = $(this).attr('id');
      setInterval(mHF,1000);     
    });
};
})(jQuery);
$(document).ready(function(){
  $('#time').jTime();
});
</script>

</body>
</html>